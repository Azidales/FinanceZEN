<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenFinance Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#0f172a', // Slate 900
                        glass: 'rgba(255, 255, 255, 0.05)',
                        glassBorder: 'rgba(255, 255, 255, 0.1)',
                        primary: '#6366f1', // Indigo 500
                        secondary: '#8b5cf6', // Violet 500
                        danger: '#ef4444',
                        success: '#10b981'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }
        
        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.07);
            transform: translateY(-2px);
        }

        /* Inputs customizados */
        input, select {
            background: rgba(15, 23, 42, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Utility */
        .hidden-force { display: none !important; }
        
        /* Treemap simulation */
        .treemap-container { display: flex; flex-wrap: wrap; gap: 4px; height: 300px; width: 100%; }
        .treemap-item { flex-grow: 1; position: relative; overflow: hidden; min-width: 50px; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-x-hidden">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <div id="view-auth" class="flex-grow flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <i class="fa-solid fa-chart-pie text-4xl text-primary mb-2"></i>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-violet-400">ZenFinance</h1>
                <p class="text-slate-400 text-sm">Controle financeiro inteligente</p>
            </div>
            
            <form id="form-auth" class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Email</label>
                    <input type="email" id="auth-email" class="w-full p-3 rounded-lg" required placeholder="seu@email.com">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Senha</label>
                    <input type="password" id="auth-pass" class="w-full p-3 rounded-lg" required placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-indigo-500/20">
                    Entrar / Registrar
                </button>
            </form>
            <p id="auth-error" class="text-danger text-sm mt-4 text-center hidden-force"></p>
        </div>
    </div>

    <div id="view-app" class="hidden-force flex-grow flex flex-col max-w-6xl mx-auto w-full p-4">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-wallet text-2xl text-secondary"></i>
                <h2 class="text-xl font-bold">ZenFinance</h2>
            </div>
            
            <div class="flex items-center gap-4 glass-panel px-4 py-2 rounded-full">
                <button id="btn-prev-month" class="text-slate-400 hover:text-white"><i class="fa-solid fa-chevron-left"></i></button>
                <input type="month" id="input-month" class="bg-transparent border-none text-center font-bold w-40 cursor-pointer">
                <button id="btn-next-month" class="text-slate-400 hover:text-white"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <button id="btn-logout" class="text-slate-400 hover:text-danger text-sm flex items-center gap-2">
                <i class="fa-solid fa-right-from-bracket"></i> Sair
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-panel p-4 rounded-xl border-l-4 border-success">
                <p class="text-slate-400 text-xs uppercase tracking-wider">Entradas</p>
                <p class="text-2xl font-bold text-success" id="summary-income">R$ 0,00</p>
            </div>
            <div class="glass-panel p-4 rounded-xl border-l-4 border-danger">
                <p class="text-slate-400 text-xs uppercase tracking-wider">Saídas</p>
                <p class="text-2xl font-bold text-danger" id="summary-expense">R$ 0,00</p>
            </div>
            <div class="glass-panel p-4 rounded-xl border-l-4 border-primary">
                <p class="text-slate-400 text-xs uppercase tracking-wider">Saldo</p>
                <p class="text-2xl font-bold text-white" id="summary-balance">R$ 0,00</p>
            </div>
        </div>

        <div class="flex gap-2 mb-4 border-b border-slate-700 pb-2">
            <button id="tab-list" class="px-4 py-2 rounded-lg bg-slate-800 text-white text-sm font-medium transition-colors border border-indigo-500/50">
                <i class="fa-solid fa-list-ul mr-2"></i> Transações
            </button>
            <button id="tab-charts" class="px-4 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white text-sm font-medium transition-colors">
                <i class="fa-solid fa-chart-simple mr-2"></i> Gráficos
            </button>
            <div class="flex-grow"></div>
            <button id="btn-add-transaction" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold shadow-lg shadow-indigo-500/30">
                <i class="fa-solid fa-plus mr-1"></i> Nova
            </button>
        </div>

        <div id="content-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow overflow-hidden">
            <div class="flex flex-col h-full">
                <h3 class="text-slate-400 text-sm font-bold mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-400"></span> 1ª Quinzena (Dia 1-15)
                </h3>
                <div id="list-col-1" class="space-y-3 overflow-y-auto pb-10" style="max-height: 60vh;">
                    </div>
            </div>

            <div class="flex flex-col h-full">
                <h3 class="text-slate-400 text-sm font-bold mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-purple-400"></span> 2ª Quinzena (Dia 16-31)
                </h3>
                <div id="list-col-2" class="space-y-3 overflow-y-auto pb-10" style="max-height: 60vh;">
                    </div>
            </div>
        </div>

        <div id="content-charts" class="hidden-force flex-grow glass-panel p-6 rounded-xl">
            <h3 class="text-lg font-bold mb-4">Mapa de Gastos (Treemap)</h3>
            <div id="treemap-visual" class="treemap-container rounded-lg overflow-hidden bg-slate-800">
                </div>
            <div id="charts-legend" class="mt-4 text-sm text-slate-400">
                </div>
        </div>
    </div>

    <div id="modal-transaction" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-sm hidden-force flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button id="btn-close-modal" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            
            <h2 class="text-xl font-bold mb-6 text-white" id="modal-title">Nova Transação</h2>

            <form id="form-transaction" class="space-y-4">
                <input type="hidden" id="trans-id">
                <input type="hidden" id="trans-original-id">

                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer">
                        <input type="radio" name="trans-type" value="expense" checked class="peer sr-only">
                        <div class="p-3 text-center rounded-lg border border-slate-600 peer-checked:bg-danger peer-checked:border-danger peer-checked:text-white text-slate-400 transition-all">
                            Saída
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="trans-type" value="income" class="peer sr-only">
                        <div class="p-3 text-center rounded-lg border border-slate-600 peer-checked:bg-success peer-checked:border-success peer-checked:text-white text-slate-400 transition-all">
                            Entrada
                        </div>
                    </label>
                </div>

                <div class="flex gap-4 items-center">
                    <label class="text-sm text-slate-300">Modo:</label>
                    <select id="trans-category" class="p-2 rounded flex-grow text-sm">
                        <option value="simple">Despesa Simples</option>
                        <option value="invoice">Fatura / Grupo</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs text-slate-400">Título / Nome da Fatura</label>
                    <input type="text" id="trans-title" class="w-full p-3 rounded-lg mt-1" required placeholder="Ex: Mercado, Nubank">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-slate-400">Data de Vencimento</label>
                        <input type="date" id="trans-date" class="w-full p-3 rounded-lg mt-1" required>
                    </div>
                    <div id="field-value-container">
                        <label class="text-xs text-slate-400">Valor Total (R$)</label>
                        <input type="number" step="0.01" id="trans-value" class="w-full p-3 rounded-lg mt-1" placeholder="0.00">
                    </div>
                </div>

                <div id="invoice-items-area" class="hidden-force border-t border-slate-700 pt-4 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs text-indigo-400 font-bold">ITENS DA FATURA</label>
                        <button type="button" id="btn-add-subitem-ui" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600">+ Item</button>
                    </div>
                    
                    <div class="glass-card p-3 rounded mb-3 grid grid-cols-12 gap-2 items-end">
                        <div class="col-span-4">
                            <input type="text" id="sub-name" placeholder="Item" class="w-full text-xs p-2 rounded">
                        </div>
                        <div class="col-span-3">
                            <input type="number" id="sub-val" placeholder="$$" class="w-full text-xs p-2 rounded">
                        </div>
                        <div class="col-span-3">
                            <input type="number" id="sub-installments" placeholder="1x" value="1" min="1" class="w-full text-xs p-2 rounded" title="Parcelas">
                        </div>
                        <div class="col-span-2">
                            <button type="button" id="btn-push-subitem" class="w-full bg-indigo-600 text-white text-xs p-2 rounded hover:bg-indigo-500">OK</button>
                        </div>
                    </div>

                    <ul id="subitems-list" class="space-y-1 max-h-40 overflow-y-auto">
                        </ul>
                </div>

                <div id="recurrence-area" class="flex items-center gap-2 mt-4 pt-4 border-t border-slate-700">
                    <input type="checkbox" id="trans-repeat" class="w-4 h-4 rounded bg-slate-800 border-slate-600">
                    <label for="trans-repeat" class="text-sm text-slate-300">Repetir transação fixa?</label>
                </div>
                <div id="repeat-months-container" class="hidden-force ml-6 mt-1">
                     <label class="text-xs text-slate-400">Quantos meses?</label>
                     <input type="number" id="trans-repeat-count" value="12" class="w-20 p-1 rounded text-sm ml-2">
                </div>

                <div class="flex gap-3 mt-6 pt-4 border-t border-slate-700">
                    <button type="button" id="btn-delete-trans" class="hidden-force bg-red-500/10 text-red-400 px-4 py-3 rounded-lg hover:bg-red-500/20">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button type="submit" class="flex-grow bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-delete" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm hidden-force flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center">
            <i class="fa-solid fa-triangle-exclamation text-3xl text-yellow-500 mb-4"></i>
            <h3 class="text-lg font-bold mb-2">Exclusão de Série</h3>
            <p class="text-slate-400 text-sm mb-6">Este item faz parte de uma série recorrente.</p>
            
            <div class="flex flex-col gap-3">
                <button id="btn-del-only" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg text-sm">
                    Apagar APENAS ESTE Mês
                </button>
                <button id="btn-del-future" class="w-full bg-danger hover:bg-red-600 text-white py-3 rounded-lg text-sm">
                    Apagar ESTE e FUTUROS
                </button>
                <button id="btn-del-cancel" class="w-full text-slate-400 hover:text-white py-2 text-sm mt-2">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            getDocs,
            writeBatch,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIGURAÇÃO (Hardcoded)
        const firebaseConfig = {
            apiKey: "AIzaSyAjbtsvVYWCFhRmDquUvf21FqQuCPS8LUk",
            authDomain: "zenfinance-a2eee.firebaseapp.com",
            projectId: "zenfinance-a2eee",
            storageBucket: "zenfinance-a2eee.firebasestorage.app",
            messagingSenderId: "798589615602",
            appId: "1:798589615602:web:d487e8ff41b91bd4d37f6b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. NAMESPACE GLOBAL
        const App = {
            State: {
                user: null,
                currentMonth: new Date().toISOString().slice(0, 7), // YYYY-MM
                transactions: [],
                unsubscribe: null,
                editingItem: null,
                tempSubItems: []
            },
            
            Utils: {
                formatCurrency: (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val),
                parseCurrency: (str) => parseFloat(str) || 0,
                formatDateBr: (dateStr) => {
                    if(!dateStr) return '';
                    const [y, m, d] = dateStr.split('-');
                    return `${d}/${m}`;
                },
                toast: (msg, type = 'info') => {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-600' : 'bg-indigo-600');
                    el.className = `${colors} text-white px-4 py-3 rounded-lg shadow-lg text-sm flex items-center gap-2 transform transition-all duration-300 translate-x-10 opacity-0`;
                    el.innerHTML = `<i class="fa-solid ${type==='error'?'fa-circle-exclamation':'fa-check-circle'}"></i> ${msg}`;
                    container.appendChild(el);
                    
                    // Animation
                    requestAnimationFrame(() => el.classList.remove('translate-x-10', 'opacity-0'));
                    setTimeout(() => {
                        el.classList.add('translate-x-10', 'opacity-0');
                        setTimeout(() => el.remove(), 300);
                    }, 3000);
                },
                addMonths: (dateStr, monthsToAdd) => {
                    const [y, m] = dateStr.split('-').map(Number);
                    const date = new Date(y, m - 1 + monthsToAdd, 1);
                    return date.toISOString().slice(0, 7);
                },
                getDay: (dateStr) => parseInt(dateStr.split('-')[2])
            },

            Auth: {
                init: () => {
                    const form = document.getElementById('form-auth');
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('auth-email').value;
                        const pass = document.getElementById('auth-pass').value;
                        const errorMsg = document.getElementById('auth-error');
                        
                        try {
                            await signInWithEmailAndPassword(auth, email, pass);
                        } catch (error) {
                            if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                                // Tenta registrar se não achar
                                try {
                                    await createUser